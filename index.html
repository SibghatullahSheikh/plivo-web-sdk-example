<html>
    <head>
        <title>Plivo JS</title>
        <link href="/static/css/bootstrap.css" rel="stylesheet">
        <script language="javascript" content-type="text/javascript" src="./jquery.js"></script>
        <script type="text/javascript" src="./plivo.min.js"></script>
	<script>
		var call_state;
		function resetPanel() {
                $('#txtStatus').text("");
                $('#call_box').show('slow');
                $('#logout_box').show('slow');
                $('#linkHangup').hide('slow');
		}		
            function onLogin() {
                $('#txtStatus').text("Logged In");
                $('#login_box').hide('slow');
                $('#call_box').show('slow');
                $('#logout_box').show('slow');
		}
		

            function onLoginFailed() {
                $('#txtStatus').text("Login failed. Please check your username/password");
            }

            function onReady() {
                console.log("onReady...");
                $('#login_box').show('slow');
                $('#txtStatus').text("");
            }
            
            function onLogout() {
                $('#txtStatus').text("Logged Out");
                $('#login_box').show('slow');
                $('#call_box').hide('slow');
                $('#logout_box').hide('slow');
                $('#incoming_callbox').hide('slow');
                $('call_box').hide('slow');
            }
			
			function onCalling() {
				call_state="calling";
				console.log("...onCalling");
				$('#linkHangup').show();
                $('#call_box').hide('slow');
				$('#txtStatus').text("Calling...");
			}
			
			function onCallRemoteRinging() {
				call_state="remotering";
				$('#txtStatus').text("Remote ringing.....");
				ringbacktone.play();
			}
			
			function onCallAnswered() {
                console.log("plivo.on call answered");
				$('#txtStatus').text("In Call");
				$('#dialpad_box').show("slow");
                $('#incoming_callbox').hide('slow');
                $('#linkHangup').show('slow');
				ringbacktone.pause();
			}
			
			function onCallTerminated() {
                console.log("onCallTerminated");
				$('#txtStatus').text("Call Ended..");
				$('#dialpad_box').hide("slow");
                $('#call_box').show('slow');
				$('#incoming_callbox').hide('slow');
				$('#linkHangup').hide();
				ringbacktone.pause();
				ringtone.pause();
			}
            
			function onEvent(evt) {
				console.log("onEvent:"+evt);
			}
			
			function onIncomingCall(display_name, user_name, account, extraHeaders) {
				console.log("onIncomingCall:"+user_name + "("+display_name+")")
                $('#txtStatus').text("Incoming call from "+user_name+".....");
				ringtone.play();
                $('#call_box').hide('slow');
				$('#incoming_callbox').show('slow');
                
                console.log("extraHeaders=");
                for (var key in extraHeaders) {
                    console.log("key="+key+".val="+extraHeaders[key]);
                }
			}
			
            function onIncomingCallCanceled() {
                console.log("onIncomingCallCanceled");
                $('#txtStatus').text("Incoming call canceled");
                $('#call_box').show('slow');
                $('#incoming_callbox').hide('slow');
                $('#linkHangup').hide();
                ringbacktone.pause();
                ringtone.pause();   
            }
            function webrtcNotSupportedAlert() {
                $('#txtStatus').text("");
                alert("Your browser doesn't support webrtc. You need latest stable chrome to use webrtc");
            }
            $(document).ready(function () {
                console.log("set callback");
                Plivo.onWebrtcNotSupported = webrtcNotSupportedAlert;
                Plivo.onReady = onReady;
                Plivo.onLogin = onLogin;
                Plivo.onLoginFailed = onLoginFailed;
                Plivo.onLogout = onLogout;
				Plivo.onCalling = onCalling;
				Plivo.onCallRemoteRinging = onCallRemoteRinging;
				Plivo.onCallAnswered = onCallAnswered;
				Plivo.onCallTerminated = onCallTerminated;
				Plivo.onIncomingCall = onIncomingCall;
                Plivo.onIncomingCallCanceled = onIncomingCallCanceled;
                config = {
                    'fallback_to_flash': true
                };
                Plivo.init(config);
            });
            function login() {
                Plivo.conn.login($("#username").val(), $("#password").val());
            }
            
            function logout() {
                Plivo.conn.logout();
            }
            function call() {
                call_state="startCall";
                extraHeaders = []
                extraHeaders.push('X-PH-header1: bandung');
                extraHeaders.push('X-PH-header2: jakarta');
                Plivo.conn.call($('#number').val(), extraHeaders);
            }
			
			function hangup() {
				Plivo.conn.hangup();
				if(call_state=="calling"){
					call_state="terminated";
					resetPanel();
				}
			}
			
			function sendDTMF(digit) {
				Plivo.conn.send_dtmf(digit);
			}
			
			function answer() {
				ringtone.pause();
				console.log("answering")
				Plivo.conn.answer();
			}
			
			function reject() {
				ringtone.pause();
				Plivo.conn.reject();
			}
			
			function mute() {
				Plivo.conn.mute();
				$('#linkUnmute').show('slow');
				$('#linkMute').hide('slow');
			}
			
			function unmute() {
				Plivo.conn.unmute();
				$('#linkUnmute').hide('slow');
				$('#linkMute').show('slow');
			}
        </script>
    
	   <style type="text/css">
       #plivooo_flash_placeholder {
            width: 220px;
            height: 150px;
        }
	   </style>
    </head>
    <body>

        <div class="container">
            <div id="txtStatus">
                Loading.....
            </div>
            <div id="login_box" title="Login" style="display: none">
                Username: <input type="text" name="username" value="2001" id="username" />
                Password: <input type="password" name="password" value="2001" id="password" />
                <input type="button" id="btn_login" onclick="login()" value="Login">
            </div>
            
            <div id="logout_box" title="Logout" style="display: none;">
                <a href="#" onclick="logout()">Logout</a>
            </div>
            
            <div class="row span12" id="call_box" title="Call out" style="display: none;">
            	 <input type="text" id="number" value="fs_ivr" size="58" />
                 <input type="button" onclick="call()" value="Call">
            </div>
			
            <div id="incoming_callbox"  style="display: none;" class="call">
                <a href="#" onclick="answer()">Answer</a>
                <a href="#" onclick="reject()">Reject</a>
                <span id="incoming_call_state_text" class="label"></span>
            </div>
            
	    <a id='linkHangup' href="#" onclick="hangup()" style="display: none;" >Hangup</a>
            <div id="dialpad_box"  style="display: none;" >
				<a id='linkMute' href="#" onclick="mute()">Mute</a> 
				<a id='linkUnmute' href="#" onclick="unmute()" style="display: none;" >Unmute</a> 
                <table cols=3 border=2 class="table-bordered table-hover">
                    <caption>Dialpad</caption>
                    <tr>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('1')">1</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('2')">2</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('3')">3</a></td>
                    </tr>                      
                    <tr>                       
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('4')">4</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('5')">5</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('6')">6</a></td>
                    </tr>                      
                    <tr>                       
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('7')">7</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('8')">8</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('9')">9</a></td>
                    </tr>                      
                    <tr>                       
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('*')">*</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('0')">0</a></td>
                        <td class="dtmfrow"><a href="#" onClick="sendDTMF('#')">#</a></td>
                    </tr>
                </table>
                
                <div id="#input_device">
                </div>
            </div>
        </div><!--container-->
    <audio id="ringtone" loop src="sounds/ringtone.wav"/>
    <audio id="ringbacktone" loop src="sounds/ringbacktone.wav"/>
    </body>
</html>
